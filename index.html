<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคิดเลขหวย v2</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles from v58 (unchanged) */
        body { font-family: 'Sarabun', 'Inter', sans-serif; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation-name: animatetop; animation-duration: 0.4s }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        #modalPermutationsList { max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; }
        #modalPermutationsList li { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.35rem; border-bottom: 1px solid #f3f4f6; }
        #modalPermutationsList li:last-child { border-bottom: none; }
        #modalPermutationsList .perm-item { display: flex; align-items: center; }
        #modalPermutationsList input[type="checkbox"] { margin-right: 1rem; height: 1.1rem; width: 1.1rem; flex-shrink: 0; }
        #modalPermutationsList .perm-number { font-weight: 500; min-width: 50px; margin-right: 1rem; font-size: 1rem; }
        #modalPermutationsList .perm-price-input { width: 90px; text-align: right; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.35rem 0.6rem; font-size: 1rem; }
        .input-error { border-color: #f87171; box-shadow: 0 0 0 2px #fecaca; }
        .menu-item { padding: 0.75rem 1.25rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; cursor: pointer; font-weight: 500; color: #d1d5db; font-size: 0.95rem; }
        .menu-item:hover { background-color: #2563eb; color: white; }
        .menu-item.active { background-color: #1e40af; color: white; }
        #hamburgerBtn { padding: 0.75rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; }
        #hamburgerBtn svg { width: 1.75rem; height: 1.75rem; }
        #hamburgerBtn:hover { background-color: #374151; }
        #dropdownMenu { position: absolute; top: 100%; right: 0; background-color: white; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); z-index: 100; min-width: 180px; padding: 0.75rem 0; }
        .dropdown-item { display: block; width: 100%; padding: 0.75rem 1.25rem; text-align: left; font-size: 1rem; color: #374151; transition: background-color 0.2s ease-in-out; }
        .dropdown-item:hover { background-color: #f3f4f6; }
        .dropdown-item.danger:hover { background-color: #fee2e2; color: #dc2626; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .button-group button { min-width: 80px; font-size: 1rem; padding-top: 0.6rem; padding-bottom: 0.6rem; }
        th, td { padding: 0.75rem 0.6rem; font-size: 1rem; }
        thead th { font-size: 0.9rem; font-weight: 700; }
        tfoot td { font-weight: 700; background-color: #f3f4f6; border-top: 2px solid #e5e7eb; }
        #grandTotalSummarySection { position: sticky; bottom: 0; left: 0; width: 100%; background-color: #1f2937; color: white; padding: 1rem; text-align: center; font-weight: 700; border-top: 2px solid #4b5563; z-index: 50; font-size: 1.1rem; }
        .limit-indicator { position: absolute; top: 0.75rem; right: 1.25rem; font-size: 1rem; color: #dc2626; font-weight: 600; }
        .limit-indicator .clear-limit-btn { color: #3b82f6; text-decoration: underline; margin-left: 0.75rem; cursor: pointer; font-size: 0.875rem; }
         .limit-indicator .clear-limit-btn:hover { color: #1d4ed8; }
         input[type=text], input[type=number] { padding: 0.6rem 0.75rem; font-size: 1.1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
         label { font-size: 1rem; margin-bottom: 0.3rem; }
         h1 { font-size: 1.75rem; margin-bottom: 1.75rem; }
         .modal-content h2 { font-size: 1.4rem; margin-bottom: 1.25rem; }
         .modal-input { border: 1px solid #d1d5db; border-radius: 0.375rem; px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg; padding: 0.6rem 0.75rem;}
        /* Style for Boxed Modal Checkbox + Input */
        .boxed-price-option { display: flex; align-items: center; margin-bottom: 1rem; gap: 0.75rem; }
        .boxed-price-option input[type="checkbox"] { height: 1.2rem; width: 1.2rem; flex-shrink: 0; }
        .boxed-price-option label { font-size: 1.1rem; font-weight: 500; flex-shrink: 0; min-width: 60px; /* Adjust as needed */ }
        .boxed-price-option input[type="number"] { flex-grow: 1; } /* Make input take remaining space */
    </style>
</head>
<body class="bg-gray-100 pb-20">
    <nav class="bg-gray-800 p-4 shadow-md mb-6">
        <div class="container mx-auto flex items-center justify-between relative">
            <div class="flex flex-wrap justify-center gap-x-5 gap-y-3">
                <button id="menu3digit" data-page="page3digit" class="menu-item active">เลข3ตัว</button>
                <button id="menu2digitTop" data-page="page2digitTop" class="menu-item">2ตัวบน</button>
                <button id="menu2digitBottom" data-page="page2digitBottom" class="menu-item">2ตัวล่าง</button>
                <button id="menuRunTop" data-page="pageRunTop" class="menu-item">วิ่งบน</button>
                <button id="menuRunBottom" data-page="pageRunBottom" class="menu-item">วิ่งล่าง</button>
                <button id="menuRun2Top" data-page="pageRun2Top" class="menu-item">วิ่ง2ตัวบน</button>
                <button id="menuPack4" data-page="pagePack4" class="menu-item">แพ4ตัว</button>
                <button id="menuPack5" data-page="pagePack5" class="menu-item">แพ5ตัว</button>
                <button id="menuCloseNumbers" data-page="pageCloseNumbers" class="menu-item">ตัวปิด</button>
                <button id="menuCloseNumbers2digit" data-page="pageCloseNumbers2digit" class="menu-item">ตัวปิด2หลัก</button>
            </div>
            <div class="relative">
                <button id="hamburgerBtn" class="text-gray-300 focus:outline-none">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
                <div id="dropdownMenu" class="hidden">
                    <button id="dropdownExportBtn" data-page="pageExport" class="dropdown-item">Export To Excel</button>
                    <button id="dropdownExportLimitedBtn" class="dropdown-item">Export เลขเกิน</button>
                    <button id="dropdownClearAllBtn" class="dropdown-item danger">ลบทั้งหมด</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="pageContainer" class="container mx-auto mb-6">
        <div id="page3digit" class="page-content active">
            <div class="max-w-7xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicator3digit" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">เลข 3 ตัว</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInput3digit" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 3 หลัก:</label>
                        <input type="text" id="numberInput3digit" maxlength="3" pattern="\d{3}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-32 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="000">
                    </div>
                    <div>
                        <label for="priceInput3digit" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInput3digit" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnStraight3digit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวตรง</button>
                        <button id="btnReversed3digit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวกลับ</button>
                        <button id="btnBoxed3digit" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวโต๊ด</button>
                        <button id="btnLimit3digit" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น(ตรง)</button>
                        <button id="btnLimit3digitBoxed" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น(โต๊ด)</button>
                        <button id="btnExport3digit" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="table3digit" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ตัวตรง (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">ตัวโต๊ด (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน(ตรง)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน(โต๊ด)</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBody3digit"></tbody>
                        <tfoot id="lottoTableFooter3digit"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="page2digitTop" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicator2digitTop" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">2 ตัวบน</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInput2digitTop" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 2 หลัก:</label>
                        <input type="text" id="numberInput2digitTop" maxlength="2" pattern="\d{2}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-28 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="00">
                    </div>
                    <div>
                        <label for="priceInput2digitTop" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInput2digitTop" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnStraight2digitTop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวตรง</button>
                        <button id="btnReversed2digitTop" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวกลับ</button>
                        <button id="btnLimit2digitTop" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExport2digitTop" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="table2digitTop" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBody2digitTop"></tbody>
                        <tfoot id="lottoTableFooter2digitTop"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="page2digitBottom" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicator2digitBottom" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">2 ตัวล่าง</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInput2digitBottom" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 2 หลัก:</label>
                        <input type="text" id="numberInput2digitBottom" maxlength="2" pattern="\d{2}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-28 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="00">
                    </div>
                    <div>
                        <label for="priceInput2digitBottom" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInput2digitBottom" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnStraight2digitBottom" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวตรง</button>
                        <button id="btnReversed2digitBottom" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ตัวกลับ</button>
                        <button id="btnLimit2digitBottom" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExport2digitBottom" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="table2digitBottom" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBody2digitBottom"></tbody>
                         <tfoot id="lottoTableFooter2digitBottom"></tfoot>
                    </table>
                </div>
            </div>
        </div>


         <div id="pageRunTop" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicatorRunTop" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">วิ่งบน</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInputRunTop" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 0-9:</label>
                        <input type="text" id="numberInputRunTop" maxlength="1" pattern="\d{1}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-24 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0">
                    </div>
                    <div>
                        <label for="priceInputRunTop" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInputRunTop" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddRunTop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่ม</button>
                        <button id="btnLimitRunTop" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExportRunTop" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="tableRunTop" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBodyRunTop"></tbody>
                         <tfoot id="lottoTableFooterRunTop"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="pageRunBottom" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicatorRunBottom" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">วิ่งล่าง</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInputRunBottom" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 0-9:</label>
                        <input type="text" id="numberInputRunBottom" maxlength="1" pattern="\d{1}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-24 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0">
                    </div>
                    <div>
                        <label for="priceInputRunBottom" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInputRunBottom" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddRunBottom" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่ม</button>
                        <button id="btnLimitRunBottom" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExportRunBottom" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="tableRunBottom" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBodyRunBottom"></tbody>
                         <tfoot id="lottoTableFooterRunBottom"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="pageRun2Top" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicatorRun2Top" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">วิ่ง 2 ตัวบน</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInputRun2Top" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 2 หลัก:</label>
                        <input type="text" id="numberInputRun2Top" maxlength="2" pattern="\d{2}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-28 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="00">
                    </div>
                    <div>
                        <label for="priceInputRun2Top" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInputRun2Top" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddRun2Top" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่ม</button>
                        <button id="btnLimitRun2Top" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExportRun2Top" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="tableRun2Top" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBodyRun2Top"></tbody>
                         <tfoot id="lottoTableFooterRun2Top"></tfoot>
                    </table>
                </div>
            </div>
        </div>


        <div id="pagePack4" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicatorPack4" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">แพ 4 ตัว</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInputPack4" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 4 หลัก:</label>
                        <input type="text" id="numberInputPack4" maxlength="4" pattern="\d{4}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0000">
                    </div>
                    <div>
                        <label for="priceInputPack4" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInputPack4" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddPack4" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่ม</button>
                        <button id="btnLimitPack4" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExportPack4" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="tablePack4" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBodyPack4"></tbody>
                         <tfoot id="lottoTableFooterPack4"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="pagePack5" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg relative">
                <div id="limitIndicatorPack5" class="limit-indicator hidden"></div>
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">แพ 5 ตัว</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="numberInputPack5" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 5 หลัก:</label>
                        <input type="text" id="numberInputPack5" maxlength="5" pattern="\d{5}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-40 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="00000">
                    </div>
                    <div>
                        <label for="priceInputPack5" class="block text-base font-medium text-gray-700 mb-2">ราคา:</label>
                        <input type="number" id="priceInputPack5" step="any"
                               class="border border-gray-300 rounded-md px-4 py-3 w-36 text-right text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddPack5" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่ม</button>
                        <button id="btnLimitPack5" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">อั้น</button>
                        <button id="btnExportPack5" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">Export (หน้านี้)</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="tablePack5" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">ตัวเลข</th>
                                <th class="border-b text-right font-bold text-gray-600">ราคา (สุทธิ)</th>
                                <th class="border-b text-right font-bold text-gray-600">เกิน</th>
                                <th class="border-b text-right font-bold text-gray-600">ยอดรวม</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="lottoTableBodyPack5"></tbody>
                         <tfoot id="lottoTableFooterPack5"></tfoot>
                    </table>
                </div>
            </div>
        </div>


        <div id="pageExport" class="page-content">
             <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">Export ข้อมูลเป็น Excel (.xlsx)</h1>
                <div class="space-y-8">
                    <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลเลข 3 ตัว</h3>
                            <p class="text-base text-gray-600">Export ตารางเลข 3 ตัวตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                        <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPage3digit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                        </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูล 2 ตัวบน</h3>
                            <p class="text-base text-gray-600">Export ตาราง 2 ตัวบนตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPage2digitTop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูล 2 ตัวล่าง</h3>
                            <p class="text-base text-gray-600">Export ตาราง 2 ตัวล่างตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPage2digitBottom" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลวิ่งบน</h3>
                            <p class="text-base text-gray-600">Export ตารางวิ่งบนตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPageRunTop" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลวิ่งล่าง</h3>
                            <p class="text-base text-gray-600">Export ตารางวิ่งล่างตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPageRunBottom" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลวิ่ง 2 ตัวบน</h3>
                            <p class="text-base text-gray-600">Export ตารางวิ่ง 2 ตัวบนตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPageRun2Top" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลแพ 4 ตัว</h3>
                            <p class="text-base text-gray-600">Export ตารางแพ 4 ตัวตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPagePack4" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>
                     <div class="p-6 border rounded-md bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-5">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-1">ข้อมูลแพ 5 ตัว</h3>
                            <p class="text-base text-gray-600">Export ตารางแพ 5 ตัวตามที่แสดงผล (ไม่รวมยอดเกิน)</p>
                        </div>
                         <div class="flex gap-4 flex-shrink-0">
                             <button id="exportPagePack5" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-md text-base">Export</button>
                         </div>
                    </div>

                    <div class="mt-10 pt-8 border-t border-gray-300 text-center">
                        <button id="exportAllTablesBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition duration-150 text-xl">
                            Export ทุกตาราง (ไฟล์เดียว หลายชีต)
                        </button>
                    </div>
                 </div>
            </div>
        </div>

        <div id="pageCloseNumbers" class="page-content">
            <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">ตัวปิด</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="closeNumberInput" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 3 หลักที่ต้องการปิด:</label>
                        <input type="text" id="closeNumberInput" maxlength="3" pattern="\d{3}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-32 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="000">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddCloseNumber" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่มเลขปิด</button>
                        <button id="btnDeleteAllCloseNumbers" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ลบเลขปิดทั้งหมด</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="closeNumbersTable" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">เลขปิด</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="closeNumbersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="pageCloseNumbers2digit" class="page-content">
            <div class="max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">ตัวปิด 2 หลัก</h1>
                <div class="input-section mb-8 p-6 bg-gray-50 rounded-md border border-gray-200 flex flex-wrap items-end gap-6">
                    <div>
                        <label for="closeNumberInput2digit" class="block text-base font-medium text-gray-700 mb-2">ป้อนเลข 2 หลักที่ต้องการปิด:</label>
                        <input type="text" id="closeNumberInput2digit" maxlength="2" pattern="\d{2}"
                               class="border border-gray-300 rounded-md px-4 py-3 w-28 text-center text-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="00">
                    </div>
                    <div class="button-group flex flex-wrap gap-3 mt-5 sm:mt-0 sm:ml-6">
                        <button id="btnAddCloseNumber2digit" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">เพิ่มเลขปิด</button>
                        <button id="btnDeleteAllCloseNumbers2digit" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-5 rounded-md shadow transition duration-150">ลบเลขปิดทั้งหมด</button>
                    </div>
                </div>
                <div class="table-section mb-8 overflow-x-auto">
                    <table id="closeNumbersTable2digit" class="min-w-full bg-white border border-gray-300 rounded-md">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border-b text-left font-bold text-gray-600">เลขปิด</th>
                                <th class="border-b text-center font-bold text-gray-600">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="closeNumbersTableBody2digit"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="grandTotalSummarySection">
                <h1 class="text-3xl font-bold text-indigo-700 mb-8 text-center">ดูตัวปิด</h1>
                <p class="text-center text-gray-600">เนื้อหาสำหรับเมนู "ดูตัวปิด" จะถูกเพิ่มที่นี่</p>
            </div>
        </div>

    </div>

    <div id="grandTotalSummarySection">
         ยอดรวมทั้งหมด: กำลังคำนวณ...
     </div>

    <div id="priceModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-5">ป้อนราคา</h2>
            <p id="modalPrompt" class="mb-5 text-base">รายละเอียด...</p>
            <div id="modalPermutationsContainer" class="mb-5 hidden">
                <label class="block text-base font-medium text-gray-700 mb-2">เลือกเลขกลับและแก้ไขราคา:</label>
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="checkAllPerms" class="mr-3 h-5 w-5">
                    <label for="checkAllPerms" class="text-base text-gray-600">เลือกทั้งหมด / ไม่เลือกทั้งหมด</label>
                </div>
                <ul id="modalPermutationsList"></ul>
            </div>
            <div id="mainModalPriceContainer" class="space-y-4">
                <div>
                    <label for="modalPriceInput" class="block text-base font-medium text-gray-700 mb-2">ราคาอั้นสูงสุด:</label>
                    <input type="number" id="modalPriceInput" step="any" class="modal-input w-full" placeholder="0.00">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-md transition duration-150 text-base">ยกเลิก</button>
                <button id="modalOkBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md transition duration-150 text-base">ตกลง</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="editModalTitle" class="text-2xl font-bold mb-5">แก้ไขข้อมูลเลข ...</h2>
            <div class="space-y-4 mb-5">
                <div>
                    <label for="editStraightInput" class="block text-base font-medium text-gray-700 mb-2">ราคา (ตั้งต้น):</label>
                    <input type="number" id="editStraightInput" step="any" class="modal-input w-full" placeholder="0.00">
                </div>
                <div id="editBoxedContainer">
                    <label for="editBoxedInput" class="block text-base font-medium text-gray-700 mb-2">ราคาโต๊ด:</label>
                    <input type="number" id="editBoxedInput" step="any" class="modal-input w-full" placeholder="0.00">
                </div>
            </div>
            <div class="flex justify-end gap-4">
                <button id="editModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-md transition duration-150 text-base">ยกเลิก</button>
                <button id="editModalOkBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-md transition duration-150 text-base">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="boxedModal" class="modal">
        <div class="modal-content">
            <h2 id="boxedModalTitle" class="text-2xl font-bold mb-5">เพิ่ม/แก้ไข เลข ...</h2>
            <div class="space-y-4 mb-6">
                 <div class="boxed-price-option">
                     <input type="checkbox" id="boxedModalStraightCheck" checked>
                     <label for="boxedModalStraightCheck">ตัวตรง</label>
                     <input type="number" id="boxedModalStraightPriceInput" step="any" class="modal-input" placeholder="0.00">
                 </div>
                 <div class="boxed-price-option">
                     <input type="checkbox" id="boxedModalBoxedCheck" checked>
                     <label for="boxedModalBoxedCheck">ตัวโต๊ด</label>
                     <input type="number" id="boxedModalBoxedPriceInput" step="any" class="modal-input" placeholder="0.00">
                 </div>
            </div>
            <div class="flex justify-end gap-4">
                <button id="boxedModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-md transition duration-150 text-base">ยกเลิก</button>
                <button id="boxedModalOkBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-md transition duration-150 text-base">ตกลง</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        // ... (Keep all previous DOM element references) ...
        const pageContainer = document.getElementById('pageContainer');
        const allPageContents = document.querySelectorAll('.page-content');
        const menuItems = document.querySelectorAll('.menu-item[data-page]');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const dropdownExportBtn = document.getElementById('dropdownExportBtn');
        const dropdownExportLimitedBtn = document.getElementById('dropdownExportLimitedBtn');
        const dropdownClearAllBtn = document.getElementById('dropdownClearAllBtn');
        // 3 Digit
        const page3digit = document.getElementById('page3digit');
        const numberInput3digit = document.getElementById('numberInput3digit');
        const priceInput3digit = document.getElementById('priceInput3digit');
        const btnStraight3digit = document.getElementById('btnStraight3digit');
        const btnReversed3digit = document.getElementById('btnReversed3digit');
        const btnBoxed3digit = document.getElementById('btnBoxed3digit');
        const btnLimit3digit = document.getElementById('btnLimit3digit');
        const btnLimit3digitBoxed = document.getElementById('btnLimit3digitBoxed');
        const btnExport3digit = document.getElementById('btnExport3digit');
        const tableBody3digit = document.getElementById('lottoTableBody3digit');
        const tableFooter3digit = document.getElementById('lottoTableFooter3digit');
        const limitIndicator3digit = document.getElementById('limitIndicator3digit');
        // 2 Digit Top
        const page2digitTop = document.getElementById('page2digitTop');
        const numberInput2digitTop = document.getElementById('numberInput2digitTop');
        const priceInput2digitTop = document.getElementById('priceInput2digitTop');
        const btnStraight2digitTop = document.getElementById('btnStraight2digitTop');
        const btnReversed2digitTop = document.getElementById('btnReversed2digitTop');
        const btnLimit2digitTop = document.getElementById('btnLimit2digitTop');
        const btnExport2digitTop = document.getElementById('btnExport2digitTop');
        const tableBody2digitTop = document.getElementById('lottoTableBody2digitTop');
        const tableFooter2digitTop = document.getElementById('lottoTableFooter2digitTop');
        const limitIndicator2digitTop = document.getElementById('limitIndicator2digitTop');
        // 2 Digit Bottom
        const page2digitBottom = document.getElementById('page2digitBottom');
        const numberInput2digitBottom = document.getElementById('numberInput2digitBottom');
        const priceInput2digitBottom = document.getElementById('priceInput2digitBottom');
        const btnStraight2digitBottom = document.getElementById('btnStraight2digitBottom');
        const btnReversed2digitBottom = document.getElementById('btnReversed2digitBottom');
        const btnLimit2digitBottom = document.getElementById('btnLimit2digitBottom');
        const btnExport2digitBottom = document.getElementById('btnExport2digitBottom');
        const tableBody2digitBottom = document.getElementById('lottoTableBody2digitBottom');
        const tableFooter2digitBottom = document.getElementById('lottoTableFooter2digitBottom');
        const limitIndicator2digitBottom = document.getElementById('limitIndicator2digitBottom');
        // Run Top
        const pageRunTop = document.getElementById('pageRunTop');
        const numberInputRunTop = document.getElementById('numberInputRunTop');
        const priceInputRunTop = document.getElementById('priceInputRunTop');
        const btnAddRunTop = document.getElementById('btnAddRunTop');
        const btnLimitRunTop = document.getElementById('btnLimitRunTop');
        const btnExportRunTop = document.getElementById('btnExportRunTop');
        const tableBodyRunTop = document.getElementById('lottoTableBodyRunTop');
        const tableFooterRunTop = document.getElementById('lottoTableFooterRunTop');
        const limitIndicatorRunTop = document.getElementById('limitIndicatorRunTop');
         // Run Bottom
        const pageRunBottom = document.getElementById('pageRunBottom');
        const numberInputRunBottom = document.getElementById('numberInputRunBottom');
        const priceInputRunBottom = document.getElementById('priceInputRunBottom');
        const btnAddRunBottom = document.getElementById('btnAddRunBottom');
        const btnLimitRunBottom = document.getElementById('btnLimitRunBottom');
        const btnExportRunBottom = document.getElementById('btnExportRunBottom');
        const tableBodyRunBottom = document.getElementById('lottoTableBodyRunBottom');
        const tableFooterRunBottom = document.getElementById('lottoTableFooterRunBottom');
        const limitIndicatorRunBottom = document.getElementById('limitIndicatorRunBottom');
         // Run 2 Top
        const pageRun2Top = document.getElementById('pageRun2Top');
        const numberInputRun2Top = document.getElementById('numberInputRun2Top');
        const priceInputRun2Top = document.getElementById('priceInputRun2Top');
        const btnAddRun2Top = document.getElementById('btnAddRun2Top');
        const btnLimitRun2Top = document.getElementById('btnLimitRun2Top');
        const btnExportRun2Top = document.getElementById('btnExportRun2Top');
        const tableBodyRun2Top = document.getElementById('lottoTableBodyRun2Top');
        const tableFooterRun2Top = document.getElementById('lottoTableFooterRun2Top');
        const limitIndicatorRun2Top = document.getElementById('limitIndicatorRun2Top');
         // Pack 4
        const pagePack4 = document.getElementById('pagePack4');
        const numberInputPack4 = document.getElementById('numberInputPack4');
        const priceInputPack4 = document.getElementById('priceInputPack4');
        const btnAddPack4 = document.getElementById('btnAddPack4');
        const btnLimitPack4 = document.getElementById('btnLimitPack4');
        const btnExportPack4 = document.getElementById('btnExportPack4');
        const tableBodyPack4 = document.getElementById('lottoTableBodyPack4');
        const tableFooterPack4 = document.getElementById('lottoTableFooterPack4');
        const limitIndicatorPack4 = document.getElementById('limitIndicatorPack4');
        // Pack 5
        const pagePack5 = document.getElementById('pagePack5');
        const numberInputPack5 = document.getElementById('numberInputPack5');
        const priceInputPack5 = document.getElementById('priceInputPack5');
        const btnAddPack5 = document.getElementById('btnAddPack5');
        const btnLimitPack5 = document.getElementById('btnLimitPack5');
        const btnExportPack5 = document.getElementById('btnExportPack5');
        const tableBodyPack5 = document.getElementById('lottoTableBodyPack5');
        const tableFooterPack5 = document.getElementById('lottoTableFooterPack5');
        const limitIndicatorPack5 = document.getElementById('limitIndicatorPack5');
        // Export Page
        const pageExport = document.getElementById('pageExport');
        const exportPage3digit = document.getElementById('exportPage3digit');
        const exportPage2digitTop = document.getElementById('exportPage2digitTop');
        const exportPage2digitBottom = document.getElementById('exportPage2digitBottom');
        const exportPageRunTop = document.getElementById('exportPageRunTop');
        const exportPageRunBottom = document.getElementById('exportPageRunBottom');
        const exportPageRun2Top = document.getElementById('exportPageRun2Top');
        const exportPagePack4 = document.getElementById('exportPagePack4');
        const exportPagePack5 = document.getElementById('exportPagePack5');
        const exportAllTablesBtn = document.getElementById('exportAllTablesBtn');
        // Modals
        const priceModal = document.getElementById('priceModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalPrompt = document.getElementById('modalPrompt');
        const modalPermutationsContainer = document.getElementById('modalPermutationsContainer');
        const modalPermutationsList = document.getElementById('modalPermutationsList');
        const checkAllPermsCheckbox = document.getElementById('checkAllPerms');
        const mainModalPriceContainer = document.getElementById('mainModalPriceContainer');
        const modalPriceInput = document.getElementById('modalPriceInput');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const editModal = document.getElementById('editModal');
        const editModalTitle = document.getElementById('editModalTitle');
        const editStraightInput = document.getElementById('editStraightInput');
        const editBoxedInput = document.getElementById('editBoxedInput');
        const editBoxedContainer = document.getElementById('editBoxedContainer');
        const editModalOkBtn = document.getElementById('editModalOkBtn');
        const editModalCancelBtn = document.getElementById('editModalCancelBtn');
        // UPDATED: Boxed Modal Elements (Checkbox + Input version)
        const boxedModal = document.getElementById('boxedModal');
        const boxedModalTitle = document.getElementById('boxedModalTitle');
        const boxedModalStraightCheck = document.getElementById('boxedModalStraightCheck'); // Checkbox
        const boxedModalStraightPriceInput = document.getElementById('boxedModalStraightPriceInput'); // Input for straight
        const boxedModalBoxedCheck = document.getElementById('boxedModalBoxedCheck');     // Checkbox
        const boxedModalBoxedPriceInput = document.getElementById('boxedModalBoxedPriceInput');   // Input for boxed
        const boxedModalOkBtn = document.getElementById('boxedModalOkBtn');
        const boxedModalCancelBtn = document.getElementById('boxedModalCancelBtn');
        // Grand Total Summary
        const grandTotalSummarySection = document.getElementById('grandTotalSummarySection');
        // Close Numbers
        const closeNumberInput = document.getElementById('closeNumberInput');
        const btnAddCloseNumber = document.getElementById('btnAddCloseNumber');
        const btnDeleteAllCloseNumbers = document.getElementById('btnDeleteAllCloseNumbers');
        const closeNumbersTableBody = document.getElementById('closeNumbersTableBody');

        // Close Numbers 2 Digit
        const closeNumberInput2digit = document.getElementById('closeNumberInput2digit');
        const btnAddCloseNumber2digit = document.getElementById('btnAddCloseNumber2digit');
        const btnDeleteAllCloseNumbers2digit = document.getElementById('btnDeleteAllCloseNumbers2digit');
        const closeNumbersTableBody2digit = document.getElementById('closeNumbersTableBody2digit');

        // --- Data Storage ---
        let lottoData3digit = {};
        let lottoData2digitTop = {};
        let lottoData2digitBottom = {};
        let lottoDataRunTop = {};
        let lottoDataRunBottom = {};
        let lottoDataRun2Top = {};
        let lottoDataPack4 = {};
        let lottoDataPack5 = {};
        let limitThresholds = {};
        let closedNumbers = [];
        let closedNumbers2digit = [];
        const LOCAL_STORAGE_KEY_PREFIX = 'lottoCalculatorData_v64.7_'; // Increment version
        const LIMIT_STORAGE_KEY = 'lottoLimitThresholds_v64.7'; // Increment version
        let currentPageType = '3digit';

        // --- Utility Functions ---
        function getPermutations(numberStr) { /* ... (unchanged) ... */
             if (typeof numberStr !== 'string' || !/^\d+$/.test(numberStr)) return [];
             const length = numberStr.length;
             if (length < 2) return [numberStr];

             if (length === 2) {
                 return numberStr[0] === numberStr[1] ? [numberStr] : [numberStr, numberStr[1] + numberStr[0]];
             }
             if (length === 3) {
                 const chars = numberStr.split(''); const r = new Set();
                 function p(a, m = '') { if (a.length === 0) { r.add(m); } else { for (let i = 0; i < a.length; i++) { let x = a.slice(), y = x.splice(i, 1); p(x.slice(), m + y); } } } p(chars);
                 return Array.from(r).sort();
             }
             return [numberStr];
         }

        function validateNDigitInput(s, n) { /* ... (unchanged) ... */
             if (n === 'RunTop' || n === 'RunBottom') {
                 return /^\d{1}$/.test(s);
             }
             else if (n === 'Pack4') { return /^\d{4}$/.test(s); }
             else if (n === 'Pack5') { return /^\d{5}$/.test(s); }
             else if (n === '2digitTop' || n === '2digitBottom' || n === 'Run2Top') {
                 return /^\d{2}$/.test(s);
             }
             else if (n === '3digit') {
                 return /^\d{3}$/.test(s);
             }
             else if (typeof n === 'number' && n > 0) {
                const regex = new RegExp(`^\\d{${n}}$`);
                return regex.test(s);
             }
             return false;
         }

        function validatePriceInput(s) { /* ... (unchanged) ... */ if (s === null || s === undefined) return false; const t = String(s).trim(); if (t === '') return false; const n = Number(t); return !isNaN(n) && isFinite(n); }
        function formatPrice(p) { /* ... (unchanged) ... */ const n = Number(p); return isNaN(n) ? '0.00' : n.toFixed(2); }
        function highlightError(element, add = true) { /* ... (unchanged) ... */ if(add) { element.classList.add('input-error'); } else { element.classList.remove('input-error'); } }
        function isNumberClosed(number) {
            return closedNumbers.includes(number);
        }
        function isNumberClosed2digit(number) {
            return closedNumbers2digit.includes(number);
        }

        // --- Local Storage Functions ---
        function loadData(type) { /* ... (unchanged, includes structure check) ... */
            const key = LOCAL_STORAGE_KEY_PREFIX + type;
            const data = localStorage.getItem(key);
            let loadedDataObject = {};
            if (data) {
                try {
                    loadedDataObject = JSON.parse(data);
                } catch (e) { console.error("Error parsing data from localStorage:", e); loadedDataObject = {}; }
            }
            // Ensure loaded data has correct structure
            Object.keys(loadedDataObject).forEach(num => {
                if (typeof loadedDataObject[num] !== 'object' || loadedDataObject[num] === null) {
                    loadedDataObject[num] = { straight: 0, boxed: 0 };
                } else {
                    if (typeof loadedDataObject[num].straight !== 'number') {
                        loadedDataObject[num].straight = 0;
                    }
                    if (typeof loadedDataObject[num].boxed !== 'number') {
                         loadedDataObject[num].boxed = 0;
                    }
                }
            });
            return loadedDataObject;
        }
        function saveData(type, dataObject) { /* ... (unchanged) ... */
             const key = LOCAL_STORAGE_KEY_PREFIX + type;
             try { localStorage.setItem(key, JSON.stringify(dataObject)); } catch (e) { console.error("Error saving data to localStorage:", e); }
         }
        function loadLimitThresholds() { /* ... (unchanged, includes structure check) ... */
            const data = localStorage.getItem(LIMIT_STORAGE_KEY);
            let loadedLimits = {};
            if (data) {
                try {
                    loadedLimits = JSON.parse(data);
                    if(typeof loadedLimits !== 'object' || loadedLimits === null) {
                        loadedLimits = {};
                    }
                } catch (e) { console.error("Error parsing limits from localStorage:", e); loadedLimits = {}; }
            }
            return loadedLimits;
        }
        function saveLimitThresholds() { /* ... (unchanged) ... */
             try { localStorage.setItem(LIMIT_STORAGE_KEY, JSON.stringify(limitThresholds)); } catch (e) { console.error("Error saving limits to localStorage:", e); }
         }

        // --- GUI Update Functions ---
        function updateTable(type) { /* ... (unchanged logic) ... */
            let data, tableBody, tableFooter;
            if (type === '3digit') { data = lottoData3digit; tableBody = tableBody3digit; tableFooter = tableFooter3digit; }
            else if (type === '2digitTop') { data = lottoData2digitTop; tableBody = tableBody2digitTop; tableFooter = tableFooter2digitTop; }
            else if (type === '2digitBottom') { data = lottoData2digitBottom; tableBody = tableBody2digitBottom; tableFooter = tableFooter2digitBottom; }
            else if (type === 'RunTop') { data = lottoDataRunTop; tableBody = tableBodyRunTop; tableFooter = tableFooterRunTop; }
            else if (type === 'RunBottom') { data = lottoDataRunBottom; tableBody = tableBodyRunBottom; tableFooter = tableFooterRunBottom; }
            else if (type === 'Run2Top') { data = lottoDataRun2Top; tableBody = tableBodyRun2Top; tableFooter = tableFooterRun2Top; }
            else if (type === 'Pack4') { data = lottoDataPack4; tableBody = tableBodyPack4; tableFooter = tableFooterPack4; }
            else if (type === 'Pack5') { data = lottoDataPack5; tableBody = tableBodyPack5; tableFooter = tableFooterPack5; }
            else { return; }

            tableBody.innerHTML = ''; tableFooter.innerHTML = '';
            let totalStraightDisplaySum = 0, totalBoxedDisplaySum = 0, totalLimitStraightSum = 0, totalLimitBoxedSum = 0, grandTotalOriginalSum = 0;
            const sortedKeys = Object.keys(data).sort();

            const limitThresholdStraight = Number(limitThresholds[`${type}_straight`]) || 0;
            const limitThresholdBoxed = (type === '3digit') ? (Number(limitThresholds[`${type}_boxed`]) || 0) : 0;

            sortedKeys.forEach(num => {
                const itemData = data[num];
                const straightOriginal = Number(itemData?.straight) || 0;
                const boxedOriginal = Number(itemData?.boxed) || 0;
                let straightDisplay = straightOriginal, boxedDisplay = boxedOriginal, limitStraightDisplay = 0, limitBoxedDisplay = 0;

                if (limitThresholdStraight > 0 && straightOriginal > limitThresholdStraight) {
                    straightDisplay = limitThresholdStraight;
                    limitStraightDisplay = straightOriginal - limitThresholdStraight;
                } else { straightDisplay = straightOriginal; limitStraightDisplay = 0; }

                if (type === '3digit') {
                     if (limitThresholdBoxed > 0 && boxedOriginal > limitThresholdBoxed) {
                         boxedDisplay = limitThresholdBoxed; limitBoxedDisplay = boxedOriginal - limitThresholdBoxed;
                     } else { boxedDisplay = boxedOriginal; limitBoxedDisplay = 0; }
                } else { boxedDisplay = 0; limitBoxedDisplay = 0; }

                const totalOriginal = straightOriginal + boxedOriginal;
                totalStraightDisplaySum += straightDisplay;
                if (type === '3digit') totalBoxedDisplaySum += boxedDisplay;
                totalLimitStraightSum += limitStraightDisplay;
                if (type === '3digit') totalLimitBoxedSum += limitBoxedDisplay;
                grandTotalOriginalSum += totalOriginal;

                const r = document.createElement('tr'); r.dataset.number = num;
                if (type === '3digit') {
                    r.innerHTML = `
                        <td class="border-b border-gray-200">${num}</td>
                        <td class="border-b border-gray-200 text-right">${formatPrice(straightDisplay)}</td>
                        <td class="border-b border-gray-200 text-right">${formatPrice(boxedDisplay)}</td>
                        <td class="border-b border-gray-200 text-right text-red-600">${limitStraightDisplay > 0 ? formatPrice(limitStraightDisplay) : '-'}</td>
                        <td class="border-b border-gray-200 text-right text-pink-600">${limitBoxedDisplay > 0 ? formatPrice(limitBoxedDisplay) : '-'}</td>
                        <td class="border-b border-gray-200 text-right font-semibold">${formatPrice(totalOriginal)}</td>
                        <td class="border-b border-gray-200 text-center">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 text-sm font-semibold mr-2" data-number="${num}" data-type="3digit">แก้ไข</button> <button class="delete-btn text-red-500 hover:text-red-700 text-sm font-semibold" data-number="${num}" data-type="3digit">ลบ</button> </td>`;
                } else {
                    r.innerHTML = `
                        <td class="border-b border-gray-200">${num}</td>
                        <td class="border-b border-gray-200 text-right">${formatPrice(straightDisplay)}</td>
                        <td class="border-b border-gray-200 text-right text-red-600">${limitStraightDisplay > 0 ? formatPrice(limitStraightDisplay) : '-'}</td>
                        <td class="border-b border-gray-200 text-right font-semibold">${formatPrice(grandTotalOriginalSum)}</td>
                        <td class="border-b border-gray-200 text-center">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 text-sm font-semibold mr-2" data-number="${num}" data-type="${type}">แก้ไข</button> <button class="delete-btn text-red-500 hover:text-red-700 text-sm font-semibold" data-number="${num}" data-type="${type}">ลบ</button> </td>`;
                }
                tableBody.appendChild(r);
            });

            const footerRow = document.createElement('tr');
            if (type === '3digit') {
                footerRow.innerHTML = `
                    <td class="text-right font-bold">ยอดรวม:</td>
                    <td class="text-right font-bold">${formatPrice(totalStraightDisplaySum)}</td>
                    <td class="text-right font-bold">${formatPrice(totalBoxedDisplaySum)}</td>
                    <td class="text-right font-bold text-red-600">${formatPrice(totalLimitStraightSum)}</td>
                    <td class="text-right font-bold text-pink-600">${formatPrice(totalLimitBoxedSum)}</td>
                    <td class="text-right font-bold">${formatPrice(grandTotalOriginalSum)}</td>
                    <td></td> `;
            } else {
                footerRow.innerHTML = `
                    <td class="text-right font-bold">ยอดรวม:</td>
                    <td class="text-right font-bold">${formatPrice(totalStraightDisplaySum)}</td>
                    <td class="text-right font-bold text-red-600">${formatPrice(totalLimitStraightSum)}</td>
                    <td class="text-right font-bold">${formatPrice(grandTotalOriginalSum)}</td>
                    <td></td> `;
            }
            tableFooter.appendChild(footerRow);
            saveData(type, data);
            updateGrandTotalSummary();
        }

        function updateGrandTotalSummary() { /* ... (unchanged logic) ... */
            let grandTotal = 0;
            const allDataObjects = [lottoData3digit, lottoData2digitTop, lottoData2digitBottom, lottoDataRunTop, lottoDataRunBottom, lottoDataRun2Top, lottoDataPack4, lottoDataPack5];

            allDataObjects.forEach(dataObject => {
                Object.values(dataObject).forEach(item => {
                    const straightOriginal = Number(item?.straight) || 0;
                    const boxedOriginal = Number(item?.boxed) || 0;
                    grandTotal += (straightOriginal + boxedOriginal);
                });
            });

            grandTotalSummarySection.textContent = `ยอดรวมทุกรายการ (ตั้งต้น): ${formatPrice(grandTotal)}`;
        }

        function updateLimitIndicator(type) { /* ... (unchanged logic) ... */
            const indicatorDiv = document.getElementById(`limitIndicator${type}`);
            if (!indicatorDiv) return;

            let thresholdStraight = 0;
            let thresholdBoxed = 0;

            if (type === '3digit') {
                thresholdStraight = Number(limitThresholds[`${type}_straight`]) || 0;
                thresholdBoxed = Number(limitThresholds[`${type}_boxed`]) || 0;
            } else {
                thresholdStraight = Number(limitThresholds[`${type}_straight`]) || 0;
            }

            indicatorDiv.innerHTML = '';

            let indicatorText = '';
            if (type === '3digit') {
                if (thresholdStraight > 0 && thresholdBoxed > 0 && thresholdStraight === thresholdBoxed) {
                    indicatorText = `อั้น: ${formatPrice(thresholdStraight)} บาท`;
                } else {
                    if (thresholdStraight > 0) indicatorText += `อั้น(ตรง): ${formatPrice(thresholdStraight)} `;
                    if (thresholdBoxed > 0) indicatorText += `อั้น(โต๊ด): ${formatPrice(thresholdBoxed)}`;
                }
            } else {
                if (thresholdStraight > 0) {
                    indicatorText = `อั้น: ${formatPrice(thresholdStraight)} บาท`;
                }
            }


            if (indicatorText) {
                indicatorDiv.textContent = indicatorText.trim();
                const clearBtn = document.createElement('span');
                clearBtn.textContent = 'ลบ';
                clearBtn.className = 'clear-limit-btn';
                clearBtn.dataset.type = type;
                clearBtn.onclick = () => clearLimit(type);
                indicatorDiv.appendChild(clearBtn);
                indicatorDiv.classList.remove('hidden');
            } else {
                indicatorDiv.classList.add('hidden');
            }
        }

        function clearLimit(type) { /* ... (unchanged logic) ... */
             console.log(`Clearing limit for type: ${type}`);
             if (type === '3digit') {
                 limitThresholds[`${type}_straight`] = 0;
                 limitThresholds[`${type}_boxed`] = 0;
             } else {
                 limitThresholds[`${type}_straight`] = 0;
             }
             saveLimitThresholds();
             updateLimitIndicator(type);
             updateTable(type);
         }

        function updateCloseNumbersTable() {
            closeNumbersTableBody.innerHTML = '';
            closedNumbers.forEach((number, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border-b border-gray-200">${number}</td>
                    <td class="border-b border-gray-200 text-center">
                        <button class="edit-close-number-btn text-blue-500 hover:text-blue-700 text-sm font-semibold mr-2" data-index="${index}">แก้ไข</button>
                        <button class="delete-close-number-btn text-red-500 hover:text-red-700 text-sm font-semibold" data-index="${index}">ลบ</button>
                    </td>`;
                closeNumbersTableBody.appendChild(row);
            });
        }

        function updateCloseNumbersTable2digit() {
            closeNumbersTableBody2digit.innerHTML = '';
            closedNumbers2digit.forEach((number, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border-b border-gray-200">${number}</td>
                    <td class="border-b border-gray-200 text-center">
                        <button class="edit-close-number-btn text-blue-500 hover:text-blue-700 text-sm font-semibold mr-2" data-index="${index}">แก้ไข</button>
                        <button class="delete-close-number-btn text-red-500 hover:text-red-700 text-sm font-semibold" data-index="${index}">ลบ</button>
                    </td>`;
                closeNumbersTableBody2digit.appendChild(row);
            });
        }

        // --- Modal Handling (Price Modal - For Limits & Reversed) ---
        let currentModalResolve = null; // Shared resolve function for modals
        let currentModalType = null;
        let currentModalTargetType = null;
        function showPriceModal(targetType, type, title, prompt, initialPrice = '', showPerms = false, perms = []) { /* ... (unchanged logic) ... */
             return new Promise((resolve) => {
                 currentModalResolve = resolve;
                 currentModalType = type;
                 currentModalTargetType = targetType;
                 modalTitle.textContent = title;
                 modalPrompt.textContent = prompt;

                 mainModalPriceContainer.classList.remove('hidden');
                 modalPermutationsContainer.classList.add('hidden');
                 modalPermutationsList.innerHTML = '';
                 highlightError(modalPriceInput, false);

                 if (type === 'reversed') {
                     mainModalPriceContainer.classList.add('hidden');
                     modalPermutationsContainer.classList.remove('hidden');
                     perms.forEach(pNum => {
                         const li = document.createElement('li');
                         li.innerHTML = `
                             <div class="perm-item"> <input type="checkbox" value="${pNum}" class="perm-checkbox" checked> <span class="perm-number">${pNum}</span> </div>
                             <input type="number" step="any" class="perm-price-input" value="${initialPrice}" placeholder="0.00"> `;
                         modalPermutationsList.appendChild(li);
                     });
                     checkAllPermsCheckbox.checked = true;
                 } else { // 'global_limit'
                     mainModalPriceContainer.querySelector('label[for="modalPriceInput"]').textContent = 'ราคาอั้นสูงสุด:';
                     let currentThreshold = 0;
                     if (targetType === '3digit') {
                         currentThreshold = Number(limitThresholds[`${targetType}_straight`]) || 0;
                     } else {
                         currentThreshold = Number(limitThresholds[`${targetType}_straight`]) || 0;
                     }
                     modalPriceInput.value = currentThreshold > 0 ? currentThreshold : '';
                 }

                 priceModal.style.display = 'flex';
                 if (type === 'global_limit') { modalPriceInput.focus(); }
                 else if (type === 'reversed' && modalPermutationsList.querySelector('.perm-price-input')) {
                      modalPermutationsList.querySelector('.perm-price-input').focus();
                    }
                });
             }
        function hidePriceModal() { /* ... (unchanged) ... */ priceModal.style.display = 'none'; }
        checkAllPermsCheckbox.addEventListener('change', (e) => { /* ... (unchanged) ... */ const c = e.target.checked; modalPermutationsList.querySelectorAll('.perm-checkbox').forEach(cb => { cb.checked = c; }); });
        modalOkBtn.addEventListener('click', () => { /* ... (unchanged logic for priceModal) ... */
            if (!currentModalResolve || !['reversed', 'global_limit'].includes(currentModalType)) return;

            let result = null; let isValid = true;

            if (currentModalType === 'reversed') {
                result = [];
                modalPermutationsList.querySelectorAll('li').forEach(li => {
                    const cb = li.querySelector('.perm-checkbox'); const piEl = li.querySelector('.perm-price-input');
                    highlightError(piEl, false);
                    if (cb && cb.checked && piEl) {
                        const num = cb.value; const priceStr = piEl.value;
                        if (validatePriceInput(priceStr)) { result.push({ number: num, price: Number(priceStr) }); }
                        else { isValid = false; highlightError(piEl); }
                    }
                });
                if (!isValid) { alert('กรุณาป้อนราคาที่ถูกต้องสำหรับทุกรายการที่เลือก'); return; }
            } else { // global_limit
                const priceStr = modalPriceInput.value;
                highlightError(modalPriceInput, false);
                if (validatePriceInput(priceStr)) { result = Number(priceStr); }
                else { isValid = false; alert('กรุณาป้อนราคาอั้นสูงสุดเป็นตัวเลขที่ถูกต้อง'); highlightError(modalPriceInput); return; }
            }
            currentModalResolve(result);
            currentModalResolve = null;
            currentModalType = null;
            hidePriceModal();
           });
        modalCancelBtn.addEventListener('click', () => { /* ... (unchanged) ... */ if (currentModalResolve) { currentModalResolve(null); currentModalResolve = null; currentModalType = null;} hidePriceModal(); });
        priceModal.addEventListener('click', (e) => { /* ... (unchanged) ... */ if (e.target === priceModal) { if (currentModalResolve) { currentModalResolve(null); currentModalResolve = null; currentModalType = null; } hidePriceModal(); } });

        // --- Edit Modal Handling ---
        let currentEditNumber = null; let currentEditType = null;
        function showEditModal(type, number) { /* ... (unchanged logic) */
             return new Promise((resolve) => {
                 currentModalResolve = resolve;
                 currentEditNumber = number;
                 currentEditType = type;
                 let data;
                 if (type === '3digit') data = lottoData3digit[number];
                 else if (type === '2digitTop') data = lottoData2digitTop[number];
                 else if (type === '2digitBottom') data = lottoData2digitBottom[number];
                 else if (type === 'RunTop') data = lottoDataRunTop[number];
                 else if (type === 'RunBottom') data = lottoDataRunBottom[number];
                 else if (type === 'Run2Top') data = lottoDataRun2Top[number];
                 else if (type === 'Pack4') data = lottoDataPack4[number];
                 else if (type === 'Pack5') data = lottoDataPack5[number];
                 else data = { straight: 0, boxed: 0 };

                 editModalTitle.textContent = `แก้ไขข้อมูลเลข ${number}`;
                 editStraightInput.value = data?.straight || '0';
                 editStraightInput.previousElementSibling.textContent = (type === '3digit' || type === '2digitTop' || type === '2digitBottom') ? 'ราคาตรง (ตั้งต้น):' : 'ราคา (ตั้งต้น):';
                 highlightError(editStraightInput, false);
                 highlightError(editBoxedInput, false);

                 if (type === '3digit') {
                     editBoxedContainer.style.display = 'block';
                     editBoxedInput.value = data?.boxed || '0';
                 } else {
                     editBoxedContainer.style.display = 'none';
                     editBoxedInput.value = '0';
                 }
                 editModal.style.display = 'flex';
                 editStraightInput.focus();
                 editStraightInput.select();
             });
           }
        function hideEditModal() { /* ... (unchanged) ... */ editModal.style.display = 'none'; }
        editModalOkBtn.addEventListener('click', () => { /* ... (unchanged logic for editModal) ... */
            if (!currentModalResolve || !currentEditType) return;

             const straightStr = editStraightInput.value;
             const boxedStr = editBoxedInput.value;
             let isValid = true;
             highlightError(editStraightInput, false);
             highlightError(editBoxedInput, false);

             if (!validatePriceInput(straightStr)) {
                 highlightError(editStraightInput);
                 isValid = false;
             }

             let updatedData = {
                 straight: Number(straightStr) || 0,
                 boxed: 0,
             };

             if (currentEditType === '3digit') {
                 if (!validatePriceInput(boxedStr)) {
                     highlightError(editBoxedInput);
                     isValid = false;
                 }
                 updatedData.boxed = Number(boxedStr) || 0;
             }

             if (isValid) {
                 currentModalResolve(updatedData);
                 currentModalResolve = null;
                 currentEditType = null;
                 hideEditModal();
             } else { alert('กรุณาป้อนราคาเป็นตัวเลขที่ถูกต้อง'); }
           });
        editModalCancelBtn.addEventListener('click', () => { /* ... (unchanged) ... */ if (currentModalResolve) { currentModalResolve(null); currentModalResolve = null; currentEditType = null; } hideEditModal(); });
        editModal.addEventListener('click', (event) => { /* ... (unchanged) ... */ if (event.target === editModal) { if (currentModalResolve) { currentModalResolve(null); currentModalResolve = null; currentEditType = null; } hideEditModal(); } });

        // --- UPDATED: Boxed Modal Handling (Checkbox + Input version) ---
        let currentBoxedNumber = null; // Keep track of the number for the boxed modal

        // UPDATED: showBoxedModal - Takes number and initial price, sets inputs and checks boxes
        function showBoxedModal(number, initialPrice) {
            return new Promise((resolve) => {
                currentModalResolve = resolve;
                currentBoxedNumber = number;

                boxedModalTitle.textContent = `เพิ่ม/แก้ไข เลข ${number}`;
                // Set initial values for both price inputs
                boxedModalStraightPriceInput.value = initialPrice;
                boxedModalBoxedPriceInput.value = initialPrice;
                // Check both boxes by default
                boxedModalStraightCheck.checked = true;
                boxedModalBoxedCheck.checked = true;
                // Clear previous errors
                highlightError(boxedModalStraightPriceInput, false);
                highlightError(boxedModalBoxedPriceInput, false);

                boxedModal.style.display = 'flex';
                boxedModalStraightPriceInput.focus(); // Focus on the first price input
                boxedModalStraightPriceInput.select();
            });
        }

        // UPDATED: hideBoxedModal - Clears inputs and resets checkboxes
        function hideBoxedModal() {
            boxedModal.style.display = 'none';
            boxedModalStraightPriceInput.value = '';
            boxedModalBoxedPriceInput.value = '';
            boxedModalStraightCheck.checked = true; // Reset check state
            boxedModalBoxedCheck.checked = true;   // Reset check state
            currentBoxedNumber = null;
            // currentModalResolve = null; // Let OK/Cancel handle resolve
        }

        // UPDATED: boxedModalOkBtn listener - Reads checkboxes and corresponding inputs
        boxedModalOkBtn.addEventListener('click', () => {
            if (!currentModalResolve || currentBoxedNumber === null) return;

            const addStraight = boxedModalStraightCheck.checked;
            const addBoxed = boxedModalBoxedCheck.checked;
            const straightValueStr = boxedModalStraightPriceInput.value;
            const boxedValueStr = boxedModalBoxedPriceInput.value;
            let isValid = true;
            let straightPrice = 0;
            let boxedPrice = 0;

            highlightError(boxedModalStraightPriceInput, false);
            highlightError(boxedModalBoxedPriceInput, false);

            // Validate straight price only if checked
            if (addStraight) {
                if (!validatePriceInput(straightValueStr)) {
                    highlightError(boxedModalStraightPriceInput);
                    isValid = false;
                } else {
                    straightPrice = Number(straightValueStr);
                }
            }

            // Validate boxed price only if checked
            if (addBoxed) {
                if (!validatePriceInput(boxedValueStr)) {
                    highlightError(boxedModalBoxedPriceInput);
                    isValid = false;
                } else {
                    boxedPrice = Number(boxedValueStr);
                }
            }

            // Check if at least one option is selected and valid
            if (!addStraight && !addBoxed) {
                 alert('กรุณาเลือกอย่างน้อยหนึ่งรายการ (ตัวตรง หรือ ตัวโต๊ด)');
                 isValid = false;
            }


            if (!isValid) {
                alert('กรุณาป้อนราคาให้ถูกต้องสำหรับรายการที่เลือก');
                return;
            }

            // Resolve with an object containing flags and prices
            currentModalResolve({
                addStraight: addStraight,
                straightPrice: straightPrice,
                addBoxed: addBoxed,
                boxedPrice: boxedPrice
            });
            currentModalResolve = null;
            hideBoxedModal();
        });

        // UPDATED: boxedModalCancelBtn listener
        boxedModalCancelBtn.addEventListener('click', () => {
            if (currentModalResolve) {
                currentModalResolve(null);
                currentModalResolve = null;
            }
            hideBoxedModal();
        });

        // UPDATED: boxedModal background click listener
        boxedModal.addEventListener('click', (event) => {
            if (event.target === boxedModal) {
                if (currentModalResolve) {
                    currentModalResolve(null);
                    currentModalResolve = null;
                }
                hideBoxedModal();
            }
        });


        // --- Excel Generation Function ---
        function generateExcel(type, exportMultiple = false) {
            const wb = XLSX.utils.book_new();

            const processData = (currentType) => {
                const tableElement = document.getElementById(`table${currentType}`);
                if (!tableElement) return null;
                const tableClone = tableElement.cloneNode(true);

                const excessColIndices = [];
                const headerCells = tableClone.querySelectorAll('thead th');
                headerCells.forEach((th, index) => {
                    if (th.textContent.includes('เกิน')) {
                        excessColIndices.push(index);
                    }
                });

                excessColIndices.slice().reverse().forEach(index => {
                    if (headerCells[index]) headerCells[index].remove();
                });

                tableClone.querySelectorAll('tbody tr').forEach(row => {
                    let netStraight = 0;
                    let netBoxed = 0;

                    const netStraightCell = row.cells[1];
                    if (netStraightCell) netStraight = parseFloat(netStraightCell.textContent.replace(/,/g, '')) || 0;

                    let totalCellIndex = -1;
                    if (currentType === '3digit') {
                        const netBoxedCell = row.cells[2];
                        if (netBoxedCell) netBoxed = parseFloat(netBoxedCell.textContent.replace(/,/g, '')) || 0;
                        totalCellIndex = 5;
                    } else {
                        totalCellIndex = 3;
                    }

                    const rowTotal = netStraight + netBoxed;
                    if (row.cells[totalCellIndex - excessColIndices.length]) {
                        row.cells[totalCellIndex - excessColIndices.length].textContent = formatPrice(rowTotal);
                    }

                    excessColIndices.slice().reverse().forEach(index => {
                        if (row.cells[index]) row.cells[index].remove();
                    });

                    if (row.cells.length > 0) row.cells[row.cells.length - 1].remove();
                });

                const footerRow = tableClone.querySelector('tfoot tr');
                if (footerRow) {
                    let footerNetStraightSum = 0;
                    let footerNetBoxedSum = 0;
                    let footerTotalCellIndex = -1;

                    const footerNetStraightCell = footerRow.cells[1];
                    if (footerNetStraightCell) footerNetStraightSum = parseFloat(footerNetStraightCell.textContent.replace(/,/g, '')) || 0;

                    if (currentType === '3digit') {
                        const footerNetBoxedCell = footerRow.cells[2];
                        if (footerNetBoxedCell) footerNetBoxedSum = parseFloat(footerNetBoxedCell.textContent.replace(/,/g, '')) || 0;
                        footerTotalCellIndex = 5;
                    } else {
                        footerTotalCellIndex = 3;
                    }

                    const footerTotal = footerNetStraightSum + footerNetBoxedSum;
                    if (footerRow.cells[footerTotalCellIndex - excessColIndices.length]) {
                        footerRow.cells[footerTotalCellIndex - excessColIndices.length].textContent = formatPrice(footerTotal);
                    }

                    excessColIndices.slice().reverse().forEach(index => {
                        if (footerRow.cells[index]) footerRow.cells[index].remove();
                    });
                    if (footerRow.cells.length > 0) footerRow.cells[footerRow.cells.length - 1].remove();
                }

                const ws = XLSX.utils.table_to_sheet(tableClone);

                // Ensure numbers with leading zeros are preserved
                Object.keys(ws).forEach(cell => {
                    if (cell.startsWith('A') && ws[cell].v) {
                        if (currentType === '2digitTop' || currentType === '2digitBottom') {
                            ws[cell].t = 's'; // Set cell type to text
                            ws[cell].v = ws[cell].v.toString().padStart(2, '0'); // Pad numbers to 2 digits
                        }
                    }
                });

                return ws;
            };

            const typeToNameMap = {
                '3digit': 'เลข3ตัว', '2digitTop': '2ตัวบน', '2digitBottom': '2ตัวล่าง',
                'RunTop': 'วิ่งบน', 'RunBottom': 'วิ่งล่าง', 'Run2Top': 'วิ่ง2ตัวบน',
                'Pack4': 'แพ4ตัว', 'Pack5': 'แพ5ตัว',
            };

            if (exportMultiple) {
                let sheetsAdded = 0;
                for (const typeKey in typeToNameMap) {
                    let dataObject;
                    if (typeKey === '3digit') dataObject = lottoData3digit;
                    else if (typeKey === '2digitTop') dataObject = lottoData2digitTop;
                    else if (typeKey === '2digitBottom') dataObject = lottoData2digitBottom;
                    else if (typeKey === 'RunTop') dataObject = lottoDataRunTop;
                    else if (typeKey === 'RunBottom') dataObject = lottoDataRunBottom;
                    else if (typeKey === 'Run2Top') dataObject = lottoDataRun2Top;
                    else if (typeKey === 'Pack4') dataObject = lottoDataPack4;
                    else if (typeKey === 'Pack5') dataObject = lottoDataPack5;
                    else dataObject = {};

                    if (Object.keys(dataObject).length > 0) {
                        const ws = processData(typeKey);
                        if (ws) {
                            XLSX.utils.book_append_sheet(wb, ws, typeToNameMap[typeKey]);
                            sheetsAdded++;
                        }
                    }
                }
                if (sheetsAdded > 0) { XLSX.writeFile(wb, "หวย.xlsx"); }
                else { alert('ไม่มีข้อมูลในตารางใดๆ ให้ Export'); }
            } else {
                let dataObject;
                if (type === '3digit') dataObject = lottoData3digit;
                else if (type === '2digitTop') dataObject = lottoData2digitTop;
                else if (type === '2digitBottom') dataObject = lottoData2digitBottom;
                else if (type === 'RunTop') dataObject = lottoDataRunTop;
                else if (type === 'RunBottom') dataObject = lottoDataRunBottom;
                else if (type === 'Run2Top') dataObject = lottoDataRun2Top;
                else if (type === 'Pack4') dataObject = lottoDataPack4;
                else if (type === 'Pack5') dataObject = lottoDataPack5;
                else { alert('ประเภทข้อมูลสำหรับ Export ไม่ถูกต้อง'); return; }

                if (Object.keys(dataObject).length === 0) { alert('ไม่มีข้อมูลในตารางนี้ให้ Export'); return; }

                const ws = processData(type);
                if (ws) {
                    XLSX.utils.book_append_sheet(wb, ws, typeToNameMap[type]);
                    const filename = `${typeToNameMap[type]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                } else { alert('ไม่สามารถสร้างไฟล์ Excel ได้ (อาจไม่มีตาราง)'); }
            }
        }

        // --- MODIFIED: generateConsolidatedLimitedExcel ---
        function generateConsolidatedLimitedExcel() { /* ... (unchanged logic) ... */
            const wb = XLSX.utils.book_new();
            let limitedDataForExport = [
                ["ประเภท", "ตัวเลข", "ยอดเกิน(ตรง/ราคา)", "ยอดเกิน(โต๊ด)", "ยอดรวมเลขเกิน"] // Headers
            ];
            let grandTotalExcess = 0;
            let hasLimitedData = false;
            let dataModified = false; // Flag to track if any data was adjusted

            const allDataTypes = [
                { type: '3digit', name: 'เลข3ตัว', data: lottoData3digit },
                { type: '2digitTop', name: '2ตัวบน', data: lottoData2digitTop },
                { type: '2digitBottom', name: '2ตัวล่าง', data: lottoData2digitBottom },
                { type: 'RunTop', name: 'วิ่งบน', data: lottoDataRunTop },
                { type: 'RunBottom', name: 'วิ่งล่าง', data: lottoDataRunBottom },
                { type: 'Run2Top', name: 'วิ่ง2ตัวบน', data: lottoDataRun2Top },
                { type: 'Pack4', name: 'แพ4ตัว', data: lottoDataPack4 },
                { type: 'Pack5', name: 'แพ5ตัว', data: lottoDataPack5 }
            ];

            // First pass: Collect data for export
            allDataTypes.forEach(({ type, name, data }) => {
                const limitThresholdStraight = Number(limitThresholds[`${type}_straight`]) || 0;
                const limitThresholdBoxed = (type === '3digit') ? (Number(limitThresholds[`${type}_boxed`]) || 0) : 0;

                Object.keys(data).sort().forEach(num => {
                    const itemData = data[num];
                    const straightOriginal = Number(itemData?.straight) || 0;
                    const boxedOriginal = Number(itemData?.boxed) || 0;
                    let limitStraightDisplay = 0;
                    let limitBoxedDisplay = 0;

                    if (limitThresholdStraight > 0 && straightOriginal > limitThresholdStraight) {
                        limitStraightDisplay = straightOriginal - limitThresholdStraight;
                    }
                    if (type === '3digit' && limitThresholdBoxed > 0 && boxedOriginal > limitThresholdBoxed) {
                        limitBoxedDisplay = boxedOriginal - limitThresholdBoxed;
                    }

                    if (limitStraightDisplay > 0 || limitBoxedDisplay > 0) {
                        hasLimitedData = true;
                        const totalExcessForNumber = limitStraightDisplay + limitBoxedDisplay;
                        limitedDataForExport.push([
                            name,
                            num,
                            limitStraightDisplay > 0 ? limitStraightDisplay : 0,
                            type === '3digit' ? (limitBoxedDisplay > 0 ? limitBoxedDisplay : 0) : '-', // Show '-' if not 3digit
                            totalExcessForNumber
                        ]);
                        grandTotalExcess += totalExcessForNumber;
                    }
                });
            });

            if (!hasLimitedData) {
                alert('ไม่มีรายการเลขเกินให้ Export');
                dropdownMenu.classList.add('hidden'); // Close dropdown even if nothing to export
                return;
            }

            // Add total row to export data
            limitedDataForExport.push([]); // Spacer row
            limitedDataForExport.push(["", "", "", "ยอดรวมเลขเกินทั้งหมด:", grandTotalExcess]);

            // Generate and save the Excel file
            try {
                const ws = XLSX.utils.aoa_to_sheet(limitedDataForExport);
                XLSX.utils.book_append_sheet(wb, ws, "เลขเกินทั้งหมด");
                XLSX.writeFile(wb, "เลขเกิน.xlsx");
                console.log("Excel file 'เลขเกิน.xlsx' generated successfully.");

                // --- NEW: Second pass: Adjust stored data after successful export ---
                allDataTypes.forEach(({ type, data }) => {
                    const limitThresholdStraight = Number(limitThresholds[`${type}_straight`]) || 0;
                    const limitThresholdBoxed = (type === '3digit') ? (Number(limitThresholds[`${type}_boxed`]) || 0) : 0;
                    let typeDataModified = false; // Track modification for this specific type

                    Object.keys(data).forEach(num => {
                        const itemData = data[num];
                        const straightOriginal = Number(itemData?.straight) || 0;
                        const boxedOriginal = Number(itemData?.boxed) || 0;
                        let itemModified = false;

                        // Adjust straight price if over limit
                        if (limitThresholdStraight > 0 && straightOriginal > limitThresholdStraight) {
                            data[num].straight = limitThresholdStraight;
                            console.log(`Adjusted straight for ${type} ${num} to ${limitThresholdStraight}`);
                            itemModified = true;
                        }

                        // Adjust boxed price if over limit (only for 3digit)
                        if (type === '3digit') {
                            if (limitThresholdBoxed > 0 && boxedOriginal > limitThresholdBoxed) {
                                data[num].boxed = limitThresholdBoxed;
                                console.log(`Adjusted boxed for ${type} ${num} to ${limitThresholdBoxed}`);
                                itemModified = true;
                            }
                        }
                        if (itemModified) {
                            typeDataModified = true;
                        }
                    });

                    // Save data if it was modified for this type
                    if (typeDataModified) {
                        saveData(type, data);
                        dataModified = true; // Mark that overall data was modified
                    }
                });

                // Update UI only if data was actually modified
                if (dataModified) {
                    console.log("Data was modified, updating UI...");
                    allDataTypes.forEach(({ type }) => {
                        updateTable(type); // Refresh table display
                    });
                    updateGrandTotalSummary(); // Recalculate and display grand total
                    alert('Export เลขเกินสำเร็จ และปรับปรุงข้อมูลในตารางเรียบร้อยแล้ว');
                } else {
                     alert('Export เลขเกินสำเร็จ (ไม่มีข้อมูลเกินลิมิตให้ปรับปรุงในตาราง)');
                }

            } catch (error) {
                console.error("Error generating or saving Excel file / adjusting data:", error);
                alert('เกิดข้อผิดพลาดในการ Export หรือปรับปรุงข้อมูล');
            }

            dropdownMenu.classList.add('hidden'); // Close dropdown
        }


        // --- Limit Button Listeners (Per-Type) ---
        // ปรับ logic ปุ่มอั้น(ตรง) เฉพาะ 3 ตัว ให้คุมเฉพาะ straight
        btnLimit3digit.addEventListener('click', async () => {
            const threshold = await showPriceModal(
                '3digit', 'global_limit', 'กำหนดราคาอั้นสูงสุด (3 ตัวตรง)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ตรง":'
            );
            if (threshold !== null && validatePriceInput(threshold)) {
                const limitValue = Number(threshold);
                limitThresholds['3digit_straight'] = limitValue;
                // ไม่แตะต้อง boxed
                saveLimitThresholds();
                updateLimitIndicator('3digit');
                updateTable('3digit');
                alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ 3 ตัวตรง เรียบร้อยแล้ว`);
                clearInputs('3digit');
            } else if (threshold !== null) {
                alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง');
            }
        });
        btnLimit3digitBoxed.addEventListener('click', async () => {
            const threshold = await showPriceModal(
                '3digit', 'global_limit', 'กำหนดราคาอั้นสูงสุด (3 ตัวโต๊ด)', 'ป้อนราคาอั้นสูงสุดสำหรับ "โต๊ด":'
            );
            if (threshold !== null && validatePriceInput(threshold)) {
                const limitValue = Number(threshold);
                limitThresholds['3digit_boxed'] = limitValue;
                saveLimitThresholds();
                updateLimitIndicator('3digit');
                updateTable('3digit');
                alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ 3 ตัวโต๊ด เรียบร้อยแล้ว`);
                clearInputs('3digit');
            } else if (threshold !== null) {
                alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง');
            }
        });
        btnLimit2digitTop.addEventListener('click', async () => {
            const threshold = await showPriceModal( '2digitTop', 'global_limit', 'กำหนดราคาอั้นสูงสุด (2 ตัวบน)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
            if (threshold !== null && validatePriceInput(threshold)) {
                const limitValue = Number(threshold); limitThresholds['2digitTop_straight'] = limitValue;
                saveLimitThresholds(); updateLimitIndicator('2digitTop'); updateTable('2digitTop');
                alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ 2 ตัวบน เรียบร้อยแล้ว`);
                clearInputs('2digitTop');
            } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
        });
        btnLimit2digitBottom.addEventListener('click', async () => {
            const threshold = await showPriceModal( '2digitBottom', 'global_limit', 'กำหนดราคาอั้นสูงสุด (2 ตัวล่าง)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
            if (threshold !== null && validatePriceInput(threshold)) {
                const limitValue = Number(threshold); limitThresholds['2digitBottom_straight'] = limitValue;
                saveLimitThresholds(); updateLimitIndicator('2digitBottom'); updateTable('2digitBottom');
                alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ 2 ตัวล่าง เรียบร้อยแล้ว`);
                clearInputs('2digitBottom');
            } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
        });
        btnLimitRunTop.addEventListener('click', async () => {
             const threshold = await showPriceModal( 'RunTop', 'global_limit', 'กำหนดราคาอั้นสูงสุด (วิ่งบน)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
             if (threshold !== null && validatePriceInput(threshold)) {
                 const limitValue = Number(threshold); limitThresholds['RunTop_straight'] = limitValue;
                 saveLimitThresholds(); updateLimitIndicator('RunTop'); updateTable('RunTop');
                 alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ วิ่งบน เรียบร้อยแล้ว`);
                 clearInputs('RunTop');
             } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
         });
        btnLimitRunBottom.addEventListener('click', async () => {
             const threshold = await showPriceModal( 'RunBottom', 'global_limit', 'กำหนดราคาอั้นสูงสุด (วิ่งล่าง)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
             if (threshold !== null && validatePriceInput(threshold)) {
                 const limitValue = Number(threshold); limitThresholds['RunBottom_straight'] = limitValue;
                 saveLimitThresholds(); updateLimitIndicator('RunBottom'); updateTable('RunBottom');
                 alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ วิ่งล่าง เรียบร้อยแล้ว`);
                 clearInputs('RunBottom');
             } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
         });
        btnLimitRun2Top.addEventListener('click', async () => {
             const threshold = await showPriceModal( 'Run2Top', 'global_limit', 'กำหนดราคาอั้นสูงสุด (วิ่ง 2 ตัวบน)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
             if (threshold !== null && validatePriceInput(threshold)) {
                 const limitValue = Number(threshold); limitThresholds['Run2Top_straight'] = limitValue;
                 saveLimitThresholds(); updateLimitIndicator('Run2Top'); updateTable('Run2Top');
                 alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ วิ่ง 2 ตัวบน เรียบร้อยแล้ว`);
                 clearInputs('Run2Top');
             } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
         });
        btnLimitPack4.addEventListener('click', async () => {
             const threshold = await showPriceModal( 'Pack4', 'global_limit', 'กำหนดราคาอั้นสูงสุด (แพ 4 ตัว)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
             if (threshold !== null && validatePriceInput(threshold)) {
                 const limitValue = Number(threshold); limitThresholds['Pack4_straight'] = limitValue;
                 saveLimitThresholds(); updateLimitIndicator('Pack4'); updateTable('Pack4');
                 alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ แพ 4 ตัว เรียบร้อยแล้ว`);
                 clearInputs('Pack4');
             } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
         });
        btnLimitPack5.addEventListener('click', async () => {
             const threshold = await showPriceModal( 'Pack5', 'global_limit', 'กำหนดราคาอั้นสูงสุด (แพ 5 ตัว)', 'ป้อนราคาอั้นสูงสุดสำหรับ "ราคา":' );
             if (threshold !== null && validatePriceInput(threshold)) {
                 const limitValue = Number(threshold); limitThresholds['Pack5_straight'] = limitValue;
                 saveLimitThresholds(); updateLimitIndicator('Pack5'); updateTable('Pack5');
                 alert(`ตั้งราคาอั้นสูงสุด ${formatPrice(limitValue)} สำหรับ แพ 5 ตัว เรียบร้อยแล้ว`);
                 clearInputs('Pack5');
             } else if (threshold !== null) { alert('คุณไม่ได้ป้อนราคาอั้นสูงสุดที่ถูกต้อง'); }
         });

        // 3 Digit
        numberInput3digit.addEventListener('input', handleInput);
        priceInput3digit.addEventListener('input', handlePriceInput);
        // เพิ่มฟังก์ชัน validateMandatoryInputs, handleInput, handlePriceInput, clearInputs ให้ถูกประกาศไว้ก่อนใช้งานปุ่ม
function validateMandatoryInputs(type) {
    let number = '', price = '';
    if (type === '3digit') {
        number = numberInput3digit.value.trim();
        price = Number(priceInput3digit.value);
        if (!/^\d{3}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === '2digitTop') {
        number = numberInput2digitTop.value.trim();
        price = Number(priceInput2digitTop.value);
        if (!/^\d{2}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === '2digitBottom') {
        number = numberInput2digitBottom.value.trim();
        price = Number(priceInput2digitBottom.value);
        if (!/^\d{2}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === 'RunTop') {
        number = numberInputRunTop.value.trim();
        price = Number(priceInputRunTop.value);
        if (!/^\d{1}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === 'RunBottom') {
        number = numberInputRunBottom.value.trim();
        price = Number(priceInputRunBottom.value);
        if (!/^\d{1}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === 'Run2Top') {
        number = numberInputRun2Top.value.trim();
        price = Number(priceInputRun2Top.value);
        if (!/^\d{2}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === 'Pack4') {
        number = numberInputPack4.value.trim();
        price = Number(priceInputPack4.value);
        if (!/^\d{4}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    if (type === 'Pack5') {
        number = numberInputPack5.value.trim();
        price = Number(priceInputPack5.value);
        if (!/^\d{5}$/.test(number) || !validatePriceInput(price)) return null;
        return { number, price };
    }
    return null;
}
function handleInput() { /* ...empty or your logic... */ }
function handlePriceInput() { /* ...empty or your logic... */ }
function clearInputs(type) {
    if (type === '3digit') { numberInput3digit.value = ''; priceInput3digit.value = ''; }
    if (type === '2digitTop') { numberInput2digitTop.value = ''; priceInput2digitTop.value = ''; }
    if (type === '2digitBottom') { numberInput2digitBottom.value = ''; priceInput2digitBottom.value = ''; }
    if (type === 'RunTop') { numberInputRunTop.value = ''; priceInputRunTop.value = ''; }
    if (type === 'RunBottom') { numberInputRunBottom.value = ''; priceInputRunBottom.value = ''; }
    if (type === 'Run2Top') { numberInputRun2Top.value = ''; priceInputRun2Top.value = ''; }
    if (type === 'Pack4') { numberInputPack4.value = ''; priceInputPack4.value = ''; }
    if (type === 'Pack5') { numberInputPack5.value = ''; priceInputPack5.value = ''; }
}

// ต้องแน่ใจว่า event listeners ของปุ่ม "ตัวตรง", "ตัวกลับ", "ตัวโต๊ด" ถูกผูกหลังจากฟังก์ชันข้างบนถูกประกาศแล้ว
btnStraight3digit.addEventListener('click', () => {
    const number = numberInput3digit.value.trim();
    if (isNumberClosed(number)) {
        alert(`เลข ${number} ปิดน้าค้าาา เลขอื่นอีกเยอะลองเลือกดูเด้อ`);
        return;
    }
    const i = validateMandatoryInputs('3digit');
    if (i) {
        const { number: n, price: p } = i;
        if (!lottoData3digit[n]) lottoData3digit[n] = { straight: 0, boxed: 0 };
        lottoData3digit[n].straight = (Number(lottoData3digit[n].straight) || 0) + p;
        updateTable('3digit'); clearInputs('3digit');
    }
});
btnReversed3digit.addEventListener('click', async () => {
    const number = numberInput3digit.value.trim();
    if (isNumberClosed(number)) {
        alert(`เลข ${number} ปิดน้าค้าาา เลขอื่นอีกเยอะลองเลือกดูเด้อ`);
        return;
    }
    const i = validateMandatoryInputs('3digit');
    if (i) {
        const { number: n, price: p } = i; const perms = getPermutations(n);
        const results = await showPriceModal('3digit', 'reversed', 'ราคาตัวกลับ (3 ตัว)', `เลือกเลขและแก้ไขราคา:`, p, true, perms);
        if (results !== null && Array.isArray(results)) {
            results.forEach(item => {
                if (!lottoData3digit[item.number]) lottoData3digit[item.number] = { straight: 0, boxed: 0 };
                lottoData3digit[item.number].straight = (Number(lottoData3digit[item.number].straight) || 0) + item.price;
            });
            updateTable('3digit'); clearInputs('3digit');
        }
    }
});
btnBoxed3digit.addEventListener('click', async () => {
    const number = numberInput3digit.value.trim();
    if (isNumberClosed(number)) {
        alert(`เลข ${number} ปิดน้าค้าาา เลขอื่นอีกเยอะลองเลือกดูเด้อ`);
        return;
    }
    const i = validateMandatoryInputs('3digit');
    if (i) {
        const { number: n, price: p } = i;
        const result = await showBoxedModal(n, p);
        if (result !== null) {
            if (!lottoData3digit[n]) lottoData3digit[n] = { straight: 0, boxed: 0 };
            if (result.addStraight) {
                lottoData3digit[n].straight = (Number(lottoData3digit[n].straight) || 0) + result.straightPrice;
            }
            if (result.addBoxed) {
                lottoData3digit[n].boxed = (Number(lottoData3digit[n].boxed) || 0) + result.boxedPrice;
            }
            updateTable('3digit');
            clearInputs('3digit');
        }
    }
});

// 2 Digit Top
numberInput2digitTop.addEventListener('input', handleInput);
priceInput2digitTop.addEventListener('input', handlePriceInput);
btnStraight2digitTop.addEventListener('click', () => {
    const number = numberInput2digitTop.value.trim();
    if (isNumberClosed2digit(number)) {
        alert(`เลข ${number} ปิดน้าค้าาา เลขอื่นอีกเยอะลองเลือกดูเด้อ`);
        return;
    }
     const i = validateMandatoryInputs('2digitTop');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoData2digitTop[n]) lottoData2digitTop[n] = { straight: 0, boxed: 0 };
         lottoData2digitTop[n].straight = (Number(lottoData2digitTop[n].straight) || 0) + p;
         lottoData2digitTop[n].boxed = 0;
         updateTable('2digitTop'); clearInputs('2digitTop');
     }
});
btnReversed2digitTop.addEventListener('click', async () => {
     const i = validateMandatoryInputs('2digitTop');
     if (i) {
         const { number: n, price: p } = i; const perms = getPermutations(n);
         const results = await showPriceModal('2digitTop', 'reversed', 'ราคาตัวกลับ (2 ตัวบน)', `เลือกเลขและแก้ไขราคา:`, p, true, perms);
         if (results !== null && Array.isArray(results)) {
             results.forEach(item => {
                 if (!lottoData2digitTop[item.number]) lottoData2digitTop[item.number] = { straight: 0, boxed: 0 };
                 lottoData2digitTop[item.number].straight = (Number(lottoData2digitTop[item.number].straight) || 0) + item.price;
                 lottoData2digitTop[item.number].boxed = 0;
             });
             updateTable('2digitTop'); clearInputs('2digitTop');
         }
     }
});
btnExport2digitTop.addEventListener('click', () => generateExcel('2digitTop'));

// 2 Digit Bottom
numberInput2digitBottom.addEventListener('input', handleInput);
priceInput2digitBottom.addEventListener('input', handlePriceInput);
btnStraight2digitBottom.addEventListener('click', () => {
    const number = numberInput2digitBottom.value.trim();
    if (isNumberClosed2digit(number)) {
        alert(`เลข ${number} ปิดน้าค้าาา เลขอื่นอีกเยอะลองเลือกดูเด้อ`);
        return;
    }
     const i = validateMandatoryInputs('2digitBottom');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoData2digitBottom[n]) lottoData2digitBottom[n] = { straight: 0, boxed: 0 };
         lottoData2digitBottom[n].straight = (Number(lottoData2digitBottom[n].straight) || 0) + p;
         lottoData2digitBottom[n].boxed = 0;
         updateTable('2digitBottom'); clearInputs('2digitBottom');
     }
});
btnReversed2digitBottom.addEventListener('click', async () => {
     const i = validateMandatoryInputs('2digitBottom');
     if (i) {
         const { number: n, price: p } = i; const perms = getPermutations(n);
         const results = await showPriceModal('2digitBottom', 'reversed', 'ราคาตัวกลับ (2 ตัวล่าง)', `เลือกเลขและแก้ไขราคา:`, p, true, perms);
         if (results !== null && Array.isArray(results)) {
             results.forEach(item => {
                 if (!lottoData2digitBottom[item.number]) lottoData2digitBottom[item.number] = { straight: 0, boxed: 0 };
                 lottoData2digitBottom[item.number].straight = (Number(lottoData2digitBottom[item.number].straight) || 0) + item.price;
                 lottoData2digitBottom[item.number].boxed = 0;
             });
             updateTable('2digitBottom'); clearInputs('2digitBottom');
         }
     }
});
btnExport2digitBottom.addEventListener('click', () => generateExcel('2digitBottom'));

// Run Top
numberInputRunTop.addEventListener('input', handleInput);
priceInputRunTop.addEventListener('input', handlePriceInput);
btnAddRunTop.addEventListener('click', () => {
     const i = validateMandatoryInputs('RunTop');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoDataRunTop[n]) lottoDataRunTop[n] = { straight: 0, boxed: 0 };
         lottoDataRunTop[n].straight = (Number(lottoDataRunTop[n].straight) || 0) + p;
         lottoDataRunTop[n].boxed = 0;
         updateTable('RunTop'); clearInputs('RunTop');
     }
 });
btnExportRunTop.addEventListener('click', () => generateExcel('RunTop'));

// Run Bottom
numberInputRunBottom.addEventListener('input', handleInput);
priceInputRunBottom.addEventListener('input', handlePriceInput);
btnAddRunBottom.addEventListener('click', () => {
     const i = validateMandatoryInputs('RunBottom');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoDataRunBottom[n]) lottoDataRunBottom[n] = { straight: 0, boxed: 0 };
         lottoDataRunBottom[n].straight = (Number(lottoDataRunBottom[n].straight) || 0) + p;
         lottoDataRunBottom[n].boxed = 0;
         updateTable('RunBottom'); clearInputs('RunBottom');
     }
 });
btnExportRunBottom.addEventListener('click', () => generateExcel('RunBottom'));

// Run 2 Top
numberInputRun2Top.addEventListener('input', handleInput);
priceInputRun2Top.addEventListener('input', handlePriceInput);
btnAddRun2Top.addEventListener('click', () => {
     const i = validateMandatoryInputs('Run2Top');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoDataRun2Top[n]) lottoDataRun2Top[n] = { straight: 0, boxed: 0 };
         lottoDataRun2Top[n].straight = (Number(lottoDataRun2Top[n].straight) || 0) + p;
         lottoDataRun2Top[n].boxed = 0;
         updateTable('Run2Top');
         clearInputs('Run2Top');
     }
 });
btnExportRun2Top.addEventListener('click', () => generateExcel('Run2Top'));


// Pack 4
numberInputPack4.addEventListener('input', handleInput);
priceInputPack4.addEventListener('input', handlePriceInput);
btnAddPack4.addEventListener('click', () => {
     const i = validateMandatoryInputs('Pack4');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoDataPack4[n]) lottoDataPack4[n] = { straight: 0, boxed: 0 };
         lottoDataPack4[n].straight = (Number(lottoDataPack4[n].straight) || 0) + p;
         lottoDataPack4[n].boxed = 0;
         updateTable('Pack4'); clearInputs('Pack4');
     }
});
btnExportPack4.addEventListener('click', () => generateExcel('Pack4'));

// Pack 5
numberInputPack5.addEventListener('input', handleInput);
priceInputPack5.addEventListener('input', handlePriceInput);
btnAddPack5.addEventListener('click', () => {
     const i = validateMandatoryInputs('Pack5');
     if (i) {
         const { number: n, price: p } = i;
         if (!lottoDataPack5[n]) lottoDataPack5[n] = { straight: 0, boxed: 0 };
         lottoDataPack5[n].straight = (Number(lottoDataPack5[n].straight) || 0) + p;
         lottoDataPack5[n].boxed = 0;
         updateTable('Pack5'); clearInputs('Pack5');
     }
});
btnExportPack5.addEventListener('click', () => generateExcel('Pack5'));

// Close Numbers
btnAddCloseNumber.addEventListener('click', () => {
    const number = closeNumberInput.value.trim();
    if (!/^\d{3}$/.test(number)) {
        alert('กรุณาป้อนเลข 3 หลักที่ถูกต้อง');
        return;
    }

    const permutations = getPermutations(number);
    let alreadyClosed = [];
    permutations.forEach(permutation => {
        if (isNumberClosed(permutation)) {
            alreadyClosed.push(permutation);
        } else {
            closedNumbers.push(permutation);
        }
    });

    if (alreadyClosed.length > 0) {
        alert(`เลขต่อไปนี้ถูกปิดอยู่แล้ว: ${alreadyClosed.join(', ')}`);
    }

    updateCloseNumbersTable();
    closeNumberInput.value = '';
});

btnDeleteAllCloseNumbers.addEventListener('click', () => {
    if (confirm('คุณต้องการลบเลขปิดทั้งหมดใช่หรือไม่?')) {
        closedNumbers = [];
        updateCloseNumbersTable();
        alert('ลบเลขปิดทั้งหมดเรียบร้อยแล้ว');
    }
});

closeNumbersTableBody.addEventListener('click', (event) => {
    const target = event.target;
    const index = target.dataset.index;
    if (target.classList.contains('edit-close-number-btn')) {
        const newNumber = prompt('แก้ไขเลขปิด:', closedNumbers[index]);
        if (newNumber && /^\d{3}$/.test(newNumber)) {
            if (isNumberClosed(newNumber)) {
                alert(`เลข ${newNumber} ปิดอยู่แล้ว`);
            } else {
                closedNumbers[index] = newNumber;
                updateCloseNumbersTable();
            }
        }
    } else if (target.classList.contains('delete-close-number-btn')) {
        if (confirm(`คุณต้องการลบเลข ${closedNumbers[index]} ใช่หรือไม่?`)) {
            closedNumbers.splice(index, 1);
            updateCloseNumbersTable();
        }
    }
});

// Close Numbers 2 Digit
btnAddCloseNumber2digit.addEventListener('click', () => {
    const number = closeNumberInput2digit.value.trim();
    if (!/^\d{2}$/.test(number)) {
        alert('กรุณาป้อนเลข 2 หลักที่ถูกต้อง');
        return;
    }

    const permutations = getPermutations(number);
    let alreadyClosed = [];
    permutations.forEach(permutation => {
        if (closedNumbers2digit.includes(permutation)) {
            alreadyClosed.push(permutation);
        } else {
            closedNumbers2digit.push(permutation);
        }
    });

    if (alreadyClosed.length > 0) {
        alert(`เลขต่อไปนี้ถูกปิดอยู่แล้ว: ${alreadyClosed.join(', ')}`);
    }

    updateCloseNumbersTable2digit();
    closeNumberInput2digit.value = '';
});

btnDeleteAllCloseNumbers2digit.addEventListener('click', () => {
    if (confirm('คุณต้องการลบเลขปิดทั้งหมดใช่หรือไม่?')) {
        closedNumbers2digit = [];
        updateCloseNumbersTable2digit();
        alert('ลบเลขปิดทั้งหมดเรียบร้อยแล้ว');
    }
});

closeNumbersTableBody2digit.addEventListener('click', (event) => {
    const target = event.target;
    const index = target.dataset.index;
    if (target.classList.contains('edit-close-number-btn')) {
        const newNumber = prompt('แก้ไขเลขปิด:', closedNumbers2digit[index]);
        if (newNumber && /^\d{2}$/.test(newNumber)) {
            if (closedNumbers2digit.includes(newNumber)) {
                alert(`เลข ${newNumber} ถูกปิดอยู่แล้ว`);
            } else {
                closedNumbers2digit[index] = newNumber;
                updateCloseNumbersTable2digit();
            }
        }
    } else if (target.classList.contains('delete-close-number-btn')) {
        if (confirm(`คุณต้องการลบเลข ${closedNumbers2digit[index]} ใช่หรือไม่?`)) {
            closedNumbers2digit.splice(index, 1);
            updateCloseNumbersTable2digit();
        }
    }
});

// --- Menu Bar Logic ---
        function setActiveMenu(selectedMenuId) { /* ... (unchanged logic) ... */
            const targetPageId = document.getElementById(selectedMenuId)?.dataset?.page;
            if (!targetPageId) return;

            if (selectedMenuId.startsWith('menu')) {
                currentPageType = selectedMenuId.substring('menu'.length);
            } else if (selectedMenuId === 'dropdownExportBtn') {
                currentPageType = 'Export';
            } else {
                 currentPageType = null;
            }

            console.log("Setting active menu:", selectedMenuId, "currentPageType:", currentPageType);

            menuItems.forEach(item => item.classList.toggle('active', item.id === selectedMenuId));
            allPageContents.forEach(content => content.classList.toggle('active', content.id === targetPageId));
            dropdownMenu.classList.add('hidden');
        }

        menuItems.forEach(item => { item.addEventListener('click', (e) => setActiveMenu(e.target.id)); });
        hamburgerBtn.addEventListener('click', (event) => { event.stopPropagation(); dropdownMenu.classList.toggle('hidden'); });
        dropdownExportBtn.addEventListener('click', () => {
             allPageContents.forEach(content => content.classList.toggle('active', content.id === 'pageExport'));
             menuItems.forEach(item => item.classList.remove('active'));
             currentPageType = 'Export';
             dropdownMenu.classList.add('hidden');
        });
        dropdownExportLimitedBtn.addEventListener('click', () => { generateConsolidatedLimitedExcel(); });

        // --- Dropdown Menu Item Click (Clear All) ---
        dropdownClearAllBtn.addEventListener('click', () => { /* ... (unchanged) ... */
            console.log("Clear All button clicked. Proceeding without confirmation.");
            lottoData3digit = {}; lottoData2digitTop = {}; lottoData2digitBottom = {};
            lottoDataRunTop = {}; lottoDataRunBottom = {}; lottoDataRun2Top = {};
            lottoDataPack4 = {}; lottoDataPack5 = {}; limitThresholds = {}; closedNumbers = []; closedNumbers2digit = [];
            console.log("In-memory data cleared.");
            const allTypes = ['3digit', '2digitTop', '2digitBottom', 'RunTop', 'RunBottom', 'Run2Top', 'Pack4', 'Pack5'];
            allTypes.forEach(type => {
                const dataKey = LOCAL_STORAGE_KEY_PREFIX + type;
                localStorage.removeItem(dataKey);
                console.log(`Removed item from localStorage: ${dataKey}`);
            });
            localStorage.removeItem(LIMIT_STORAGE_KEY);
            console.log(`Removed item from localStorage: ${LIMIT_STORAGE_KEY}`);
            allTypes.forEach(type => {
                try {
                    updateTable(type); updateLimitIndicator(type);
                    console.log(`UI updated for type: ${type}`);
                } catch (error) { console.error(`Error updating UI for type ${type}:`, error); }
            });
            try {
                updateGrandTotalSummary(); console.log("Grand total summary updated.");
            } catch(error) {
                 console.error("Error updating grand total summary:", error);
            }
            updateCloseNumbersTable();
            updateCloseNumbersTable2digit();
            alert('ลบข้อมูลทั้งหมดเรียบร้อยแล้ว');
            dropdownMenu.classList.add('hidden');
        });

        document.addEventListener('click', (event) => { /* ... (unchanged) ... */
            if (!hamburgerBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });


        // --- Edit/Delete Listener (Event Delegation on Tables) ---
        pageContainer.addEventListener('click', async (event) => { /* ... (unchanged logic) ... */
             const target = event.target;
             const number = target.dataset.number;
             const type = target.dataset.type;
             if (!type || !number) return;

             let dataObject;
             if (type === '3digit') dataObject = lottoData3digit;
             else if (type === '2digitTop') dataObject = lottoData2digitTop;
             else if (type === '2digitBottom') dataObject = lottoData2digitBottom;
             else if (type === 'RunTop') dataObject = lottoDataRunTop;
             else if (type === 'RunBottom') dataObject = lottoDataRunBottom;
             else if (type === 'Run2Top') dataObject = lottoDataRun2Top;
             else if (type === 'Pack4') dataObject = lottoDataPack4;
             else if (type === 'Pack5') dataObject = lottoDataPack5;
             else { console.error(`Unknown type "${type}"`); return; }

             if (target.classList.contains('edit-btn')) {
                 if (!dataObject[number]) {
                    console.warn(`Edit button clicked for non-existent number: ${type} - ${number}`);
                    return;
                 }
                 const updatedData = await showEditModal(type, number);
                 if (updatedData !== null) {
                     dataObject[number].straight = updatedData.straight;
                     if (type === '3digit') {
                        dataObject[number].boxed = updatedData.boxed;
                     }
                     updateTable(type);
                 }
             } else if (target.classList.contains('delete-btn')) {
                 if (!dataObject[number]) {
                    console.warn(`Delete button clicked for non-existent number: ${type} - ${number}`);
                    return;
                 }
                 console.log(`Proceeding to delete ${type} - ${number}`);
                 delete dataObject[number];
                 updateTable(type);
                 // alert(`ลบเลข ${number} (${type}) เรียบร้อยแล้ว`); // Consider removing
             }
         });

         // --- Export Page Button Listeners ---
         exportPage3digit.addEventListener('click', () => generateExcel('3digit'));
         exportPage2digitTop.addEventListener('click', () => generateExcel('2digitTop'));
         exportPage2digitBottom.addEventListener('click', () => generateExcel('2digitBottom'));
         exportPageRunTop.addEventListener('click', () => generateExcel('RunTop'));
         exportPageRunBottom.addEventListener('click', () => generateExcel('RunBottom'));
         exportPageRun2Top.addEventListener('click', () => generateExcel('Run2Top'));
         exportPagePack4.addEventListener('click', () => generateExcel('Pack4'));
         exportPagePack5.addEventListener('click', () => generateExcel('Pack5'));
         exportAllTablesBtn.addEventListener('click', () => generateExcel(null, true));


        // --- Function to handle Enter key press on number inputs ---
        function handleEnterKey(event, nextInputId) { /* ... (unchanged) ... */
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                const nextInput = document.getElementById(nextInputId);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }

        // --- Attach Enter Key Listeners to Number Inputs ---
        numberInput3digit.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInput3digit'));
        numberInput2digitTop.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInput2digitTop'));
        numberInput2digitBottom.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInput2digitBottom'));
        numberInputRunTop.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInputRunTop'));
        numberInputRunBottom.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInputRunBottom'));
        numberInputRun2Top.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInputRun2Top'));
        numberInputPack4.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInputPack4'));
        numberInputPack5.addEventListener('keydown', (e) => handleEnterKey(e, 'priceInputPack5'));


        // --- Initial Load ---
        function initializeApp() {
            console.log("Initializing App v64.5..."); // Update version log
            lottoData3digit = loadData('3digit');
            lottoData2digitTop = loadData('2digitTop');
            lottoData2digitBottom = loadData('2digitBottom');
            lottoDataRunTop = loadData('RunTop');
            lottoDataRunBottom = loadData('RunBottom');
            lottoDataRun2Top = loadData('Run2Top');
            lottoDataPack4 = loadData('Pack4');
            lottoDataPack5 = loadData('Pack5');
            limitThresholds = loadLimitThresholds();

            const allTypes = ['3digit', '2digitTop', '2digitBottom', 'RunTop', 'RunBottom', 'Run2Top', 'Pack4', 'Pack5'];
            allTypes.forEach(type => {
                try {
                    updateTable(type);
                    updateLimitIndicator(type);
                } catch (error) {
                    console.error(`Error initializing UI for type ${type}:`, error);
                }
            });

            try {
                updateGrandTotalSummary();
            } catch(error) {
                 console.error("Error initializing grand total:", error);
            }
            updateCloseNumbersTable();
            updateCloseNumbersTable2digit();
            setActiveMenu('menu3digit'); // Set initial active menu
            console.log("App Initialized.");
        }

        initializeApp(); // Run initialization

    </script>
</body>
</html>
